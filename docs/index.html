<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<title>Cemu Graphic Packs</title>
	<link rel="stylesheet" type="text/css" href="css/index.css">
	<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
	<!-- >>> Javascript functions <<< -->
	<script>
		// Calculate Github repository info, avoid using extra api calls.
		repositoryUsername = "Crementif"; // Replace with window.location.host.split(".")[0];
		repositoryName = "CemuGraphicPacks"; // Replace with window.location.pathname.split("/")[1];
		defaultFetchUrl = "https://api.github.com/repos/"+repositoryUsername+"/"+repositoryName+"/git/trees/master:src?recursive=3";
		// This info is only used to make 'dynamic' fetch calls.
		
		
		var gameList = new Object;
		
		function addGameList(folderName, gameTitle) { // Use template to add a new game entry to the list. The passed variables will change the result.
			gameListTemplate = document.querySelector('#gameListTemplate');
			gameListTemplate.content.querySelector('input').id=folderName;
			gameListTemplate.content.querySelector('label').htmlFor=folderName;
			gameListTemplate.content.querySelector('label').innerText=gameTitle[0]; // The first search tag should always be the game name.
			gameListTemplate.content.querySelector('div').dataset.searchtags=JSON.stringify(gameTitle); // Store all the tags in an attribute.
			
			document.getElementsByName("selectGames")[0].appendChild(document.importNode(gameListTemplate.content, true));
		}
		function filterGameList(searchString) {
			gameNodes = document.getElementsByClassName("gameList");
			searchResults = 0;
			for (i=0; i<gameNodes.length; i++) { // Cycle through all of the games
				for (j=0; j<JSON.parse(gameNodes[i].dataset.searchtags).length; j++) { // Cycle trough each of the search tags
					if (JSON.parse(gameNodes[i].dataset.searchtags)[j].toUpperCase().indexOf(searchString.value.toUpperCase()) > -1) {
						gameNodes[i].style.display = ""; // Found matching search tag.
						searchResults += 1;
						break; // Break and continue to check for other games.
					}
					else {
						gameNodes[i].style.display = "none"; // Hide game from the list, but it next search tag might reveal it.
					}
				}
			}
			console.log("Received "+searchResults+" search results.");
		}
		function fetchGameInfo(fetchUrl) { // Fetch repository contents
			if (typeof fetch === "function") {
				fetch(fetchUrl, {cache: "default"}).then( // Todo: Fetch Github's hourly api limit, then decide whether to use the cached version if it's used up.
					function(response) {
						if (response.status !== 200) {
							console.warn("A wild fetch problem appeared! It's super effective! It's Fetch Status Codeâ„¢ is "+response.status);
							return;
						}
						response.json().then(function(data) {
							console.debug(data);
							// Now sort this data to some usable data object.
							appendTo = "";
							for (i = 0; i < data.tree.length; i++) {
								if (data.tree[i].path.split("/").length - 1 == 0) {
									appendTo = data.tree[i].path;
								}
							}
						})
					}
				)
			}
			else {
				console.warn("Fetch isn't supported (yet) for your browser. If you get this error, your browser isn't yet supported by this website.");
				// TODO: Implement a polyfill to support more browsers.
			}
		}
		fetchGameInfo(defaultFetchUrl);
	</script>
	<!-- <<< End Javascript >>> -->
</head>
<body>
	<header>
		<a id="logo" href="/index.html">Cemu Graphic Packs</a>
		<nav>
			<ul class="progressBar">
				<li><a id="progressBar1" href="#">Download Graphic Packs</a></li>
				<li><a id="progressBar2" href="#">Select additional packs</a></li>
			</ul>
		</nav>
	</header>
	
	<main>
		<form name="selectGames" enctype="text/plain">
			<p>Select a few of these graphic packs!<br></p>
			<input type="search" id="searchGames" placeholder="Search games..." oninput="filterGameList(this)">
			
			<template id="gameListTemplate">
				<div class="gameList" data-searchtags="arraySearchTags">
					<input type="checkbox" id="folderName" name="game">
					<label for="folderName">gameTitle</label>
				</div>
			</template>
			
			<script>
				addGameList("BreathOfTheWild", ['Breath of the Wild', 'BotW']);
				addGameList("Test2", ['OtherCoolGame', 'MarioOdessey']);
				addGameList("Test3", ['CemuOtherGame']);
			</script>
		</form>
	</main>
	
	<footer>
		Site created by Crementif. <a href="">Help us over on github!</a> <a href="">Site not working?</a>
	</footer>
</body>
</html>
