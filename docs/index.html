<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<title>Cemu Graphic Packs</title>
	<link rel="stylesheet" type="text/css" href="css/index.css">
	<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
	<!-- >>> Javascript functions <<< -->
	<script>
		// Calculate Github repository info, avoid using extra api calls.
		repositoryUsername = "Crementif"; // Replace with window.location.host.split(".")[0];
		repositoryName = "CemuGraphicPacks"; // Replace with window.location.pathname.split("/")[1];
		defaultFetchUrl = "https://api.github.com/repos/"+repositoryUsername+"/"+repositoryName+"/git/trees/master:src?recursive=3";
		defaultFileUrl = "https://raw.githubusercontent.com/"+repositoryUsername+"/"+repositoryName+"/master/src/"
		// This info is only used to make 'dynamic' fetch calls.
		
		
		var gameList = [];
		
		function addGameList(folderName, gameTitle) { // Use template to add a new game entry to the list. The passed variables will change the result.
			gameListTemplate = document.querySelector('#gameListTemplate');
			gameListTemplate.content.querySelector('input').id=folderName;
			gameListTemplate.content.querySelector('label').htmlFor=folderName;
			gameListTemplate.content.querySelector('label').innerText=gameTitle[0]; // The first search tag should always be the game name.
			gameListTemplate.content.querySelector('div').dataset.searchtags=JSON.stringify(gameTitle); // Store all the tags in an attribute.
			
			document.getElementsByName("selectGames")[0].appendChild(document.importNode(gameListTemplate.content, true));
		}
		function filterGameList(searchString) {
			gameNodes = document.getElementsByClassName("gameList");
			searchResults = 0;
			for (i=0; i<gameNodes.length; i++) { // Cycle through all of the games
				for (j=0; j<JSON.parse(gameNodes[i].dataset.searchtags).length; j++) { // Cycle trough each of the search tags
					if (JSON.parse(gameNodes[i].dataset.searchtags)[j].toUpperCase().indexOf(searchString.value.toUpperCase()) > -1) {
						gameNodes[i].style.display = ""; // Found matching search tag.
						searchResults += 1;
						break; // Break and continue to check for other games.
					}
					else {
						gameNodes[i].style.display = "none"; // Hide game from the list, but it next search tag might reveal it.
					}
				}
			}
			console.log("Received "+searchResults+" search results.");
		}
		
		function fetchGameInfo(fetchUrl) { // Fetch repository contents
			if (typeof fetch === "function") {
				fetch(fetchUrl, {cache: "force-cache", headers: {Accept: "application/vnd.github.v3+json"}}).then( // Todo: Check if caching mode works with "default".
					function(response) {
						if (response.status !== 200) {
							console.warn("A wild fetch problem appeared! It's super effective! It's Fetch Status Codeâ„¢ is "+response.status);
							return;
						}
						response.json().then(function(data) {
							console.debug(data);
							// Now sort this data to some usable data object.
							for (i = 0; i < data.tree.length; i++) {
								if (data.tree[i].path.split("/").length - 1 == 0) {
									// All data now needs to be appended to this game entry in our database object.
									console.debug(">>> Found "+data.tree[i].path);
									gameList.push({folderName: data.tree[i].path});
								}
								else if (data.tree[i].path == gameList[gameList.length-1].folderName+"/rules.txt") {
									// Found the main resolution pack rules, which contains most of our info.
									fetch(defaultFileUrl+data.tree[i].path, {cache: "force-cache"}).then(
										function(response) {
											if (response.status !== 200) {
												console.warn("Oh no, it's fetch status code is retarded! Fetch status code is "+response.status);
												return;
											}
											response.text().then(function(rulesString) {
												rulesFile = rulesString.match(/[^\r\n]+/g);									
												for (j = 0; j < rulesFile.length; j++) {
													// Support comments. Need to remove them before checking cases on it.
													cleanLine = rulesFile[j].substr(0, -rulesFile[j].indexOf("#")>0 ? rulesFile[j].length : rulesFile[j].indexOf("#")); // Remove lines.
													console.log(">>>> "+cleanLine);
													// Now process each line and we'll have the parsed file.
													if (cleanLine.trim() == "[Definition]") {
														currentSection = cleanLine.trim();
														console.log("Definitely definition!");
													}
													else if (cleanLine.trim().charAt(0) == '[' && cleanLine.trim().slice(-1) == ']') {
														console.log("Found section: "+cleanLine);
													}
													//console.log(cleanLine.charAt(0)+" and "+rulesFile[j].slice(-1));
												}
												//console.log(rulesFile);
											})
										}
									)
								}
								else if (data.tree[i].path == gameList[gameList.length-1].folderName+"/patches.txt") {
									// Found ultrawide screen patches.
								}
								else if (data.tree[i].path == gameList[gameList.length-1].folderName+"/preview/") {
									// Found preview pictures.
								}
							}
							console.log(gameList);
						})
					}
				)
			}
			else {
				console.warn("Fetch isn't supported (yet) for your browser. If you get this error, your browser isn't yet supported by this website.");
				// TODO: Implement a polyfill to support more browsers.
			}
		}
		fetchGameInfo(defaultFetchUrl);
	</script>
	<!-- <<< End Javascript >>> -->
</head>
<body>
	<header>
		<a id="logo" href="/index.html">Cemu Graphic Packs</a>
		<nav>
			<ul class="progressBar">
				<li><a id="progressBar1" href="#">Download Graphic Packs</a></li>
				<li><a id="progressBar2" href="#">Select additional packs</a></li>
			</ul>
		</nav>
	</header>
	
	<main>
		<form name="selectGames" enctype="text/plain">
			<p>Select a few of these graphic packs!<br></p>
			<input type="search" id="searchGames" placeholder="Search games..." oninput="filterGameList(this)">
			
			<template id="gameListTemplate">
				<div class="gameList" data-searchtags="arraySearchTags">
					<input type="checkbox" id="folderName" name="game">
					<label for="folderName">gameTitle</label>
				</div>
			</template>
			
			<script>
				addGameList("BreathOfTheWild", ['Breath of the Wild', 'BotW']);
				addGameList("Test2", ['OtherGame', 'MarioOdessey']);
				addGameList("Test3", ['AndAnotherCoolGame']);
			</script>
		</form>
	</main>
	
	<footer>
		<a href="">Help us over on github!</a> <a href="">Site not working?</a> <a href="">Graphic packs for Cemu&lt;1.8.0</a>
	</footer>
</body>
</html>
